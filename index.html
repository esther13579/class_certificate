<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>翻轉教育-班級獎狀產生器</title>
    
    <!-- ★★★ 關鍵修復：解決 GitHub Pages 路徑錯誤問題 ★★★ -->
    <base href=".">
    
    <!-- 1. 載入 Tailwind CSS (樣式庫) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. 載入 React 核心 -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- 3. 載入 Babel (讓瀏覽器看得懂 React) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 設定字體 -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&family=Noto+Serif+TC:wght@400;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        .font-serif { font-family: 'Noto Serif TC', serif; }
        .font-mono { font-family: monospace; }
        
        /* 動畫效果 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fadeIn { animation: fadeIn 0.5s ease-out forwards; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="root"></div>

    <script type="text/babel">
        // --- 0. 圖標元件庫 (內建 SVG) ---
        const Icons = {
            User: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
            Users: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
            Calendar: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>,
            Type: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polyline points="4 7 4 4 20 4 20 7"/><line x1="9" y1="20" x2="15" y2="20"/><line x1="12" y1="4" x2="12" y2="20"/></svg>,
            BookOpen: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>,
            FileText: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>,
            Upload: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
            ChevronLeft: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polyline points="15 18 9 12 15 6"/></svg>,
            ChevronRight: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polyline points="9 18 15 12 9 6"/></svg>,
            Sparkles: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3z"/></svg>,
            Copy: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>,
            Layout: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></svg>,
            CheckCircle: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>,
            ImageIcon: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>,
            Download: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
            DownloadCloud: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><polyline points="12 12 12 21"/><polyline points="8 17 12 21 16 17"/></svg>,
            ArrowRight: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>,
            Gift: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polyline points="20 12 20 22 4 22 4 12"/><rect x="2" y="7" width="20" height="5"/><line x1="12" y1="22" x2="12" y2="7"/><path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"/><path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"/></svg>
        };

        const { useState, useEffect, useRef } = React;

        const FlipAwardGenerator = () => {
            const [mode, setMode] = useState('single'); 
            const [teacherName, setTeacherName] = useState('王小明 老師');
            const [date, setDate] = useState(new Date().toISOString().split('T')[0]); 

            const [studentName, setStudentName] = useState('張小美');
            const [awardTitle, setAwardTitle] = useState('閱讀小博士');
            const [comment, setComment] = useState('這學期主動閱讀了 50 本書，並樂於與同學分享心得，這份熱情值得嘉許！');
            const [showPresets, setShowPresets] = useState(false);
            
            const [batchData, setBatchData] = useState([]); 
            const [currentBatchIndex, setCurrentBatchIndex] = useState(0);
            const [csvInput, setCsvInput] = useState('');

            const [aiPrompt, setAiPrompt] = useState('');

            const [selectedTemplate, setSelectedTemplate] = useState('classic');
            const canvasRef = useRef(null);

            // --- 完整 30 款 PDF 獎項資料庫 (根據您提供的 PDF 內容提取) ---
            const presetAwards = [
                // 個人特質
                { category: '個人特質', title: '永不放棄獎', text: '在困難或挑戰面前從不氣餒，持之以恆，堅持不懈，展現出色的毅力和堅韌精神，值得嘉許！' },
                { category: '個人特質', title: '靈感啟蒙獎', text: '在激發同學學習興趣、分享知識或鼓勵他人方面有卓越表現，值得嘉許！' },
                { category: '個人特質', title: '積極參與獎', text: '全年積極參與課堂、課外活動，為班級做出貢獻，值得嘉許！' },
                { category: '個人特質', title: '自我管理獎', text: '在自我管理、時間規劃或目標達成方面有優異表現，值得嘉許！' },
                { category: '個人特質', title: '優秀守時者', text: '準時完成任務、上課或參與活動，展現出良好的時間管理和守時的價值觀，值得嘉許！' },
                // 人際關係
                { category: '人際關係', title: '友善大使', text: '促進友誼、關懷他人或解決衝突方面表現優秀，值得嘉許！' },
                { category: '人際關係', title: '樂於助人獎', text: '樂於幫助他人，願意伸出援手，關心同學、老師或他人的需求，展現出色的同理心和關懷之心，值得嘉許！' },
                { category: '人際關係', title: '社交冠軍', text: '在社交場合中展現出色的溝通能力和人際技巧，值得嘉許！' },
                { category: '人際關係', title: '心靈小園丁', text: '關懷同學或提供幫助方面有積極表現，值得嘉許！' },
                { category: '人際關係', title: '未來小領袖', text: '展現領導潛力、積極影響力和未來發展前景，值得嘉許！' },
                // 多元才藝
                { category: '多元才藝', title: '閱讀小將', text: '對書籍有濃厚興趣，並積極參與閱讀活動，值得嘉許！' },
                { category: '多元才藝', title: '最強運動員', text: '在體育運動方面表現出色，值得嘉許！' },
                { category: '多元才藝', title: '表演之星', text: '在舞台表演、音樂演奏或舞蹈領域表現突出，值得嘉許！' },
                { category: '多元才藝', title: '健康食尚獎', text: '在飲食健康、食物營養或烹飪有優秀的技能，值得嘉許！' },
                { category: '多元才藝', title: '設計小達人', text: '在設計、手繪或創意製作方面有優秀表現，值得嘉許！' },
                { category: '多元才藝', title: '綠手指獎', text: '在校園園藝、植物栽培或環境美化方面有突出貢獻，值得嘉許！' },
                { category: '多元才藝', title: '科技小達人', text: '在電子設備、科技應用或創新發明方面表現出色，值得嘉許！' },
                { category: '多元才藝', title: '語言小達人', text: '對語言學習有熱情，並在學習外語或口語表達方面表現優異，值得嘉許！' },
                { category: '多元才藝', title: '創意寫作王', text: '在創作故事、詩歌或短文方面展現出色，值得嘉許！' },
                { category: '多元才藝', title: '資訊搜尋達人', text: '在網路上能快速、精準地找到所需資訊的能力，值得嘉許！' },
                { category: '多元才藝', title: '說書達人', text: '在故事寫作、口述故事或敘述方面有優異表現，值得嘉許！' },
                { category: '多元才藝', title: '遊戲設計獎', text: '在遊戲設計、策劃或創造方面有獨特見解，值得嘉許！' },
                { category: '多元才藝', title: '教學助理獎', text: '在協助教學、輔導同學或解答問題方面有突出貢獻，值得嘉許！' },
                { category: '多元才藝', title: '思辯哲學家', text: '在思辯、提出問題或哲學思考方面有深入探索，值得嘉許！' },
                { category: '多元才藝', title: '特殊才能獎', text: '擁有特殊才能或技能，表現出眾，值得嘉許！' },
                // 其他
                { category: '其他', title: '綜合進步獎', text: '在多方面展現進步，表現出全面的學習態度和成長，值得嘉許！' },
                { category: '其他', title: '動物友善獎', text: '對動物保護、關懷或野生動物有特別的熱情和關注，值得嘉許！' },
                { category: '其他', title: '最佳義工', text: '積極參與義工活動，為社區或校園做出卓越貢獻，值得嘉許！' },
                { category: '其他', title: '水源小尖兵', text: '對節水、保護水資源或倡導水資源循環利用有重要貢獻，值得嘉許！' },
                { category: '其他', title: '愛護地球獎', text: '在環保、永續發展或愛護地球行動中有積極參與，值得嘉許！' },
            ];

            const templates = [
                { id: 'classic', name: '經典榮譽', bgImage: null, bg: '#ffffff', border: '#1e40af', font: 'serif', textColor: '#1e3a8a', accent: '#fbbf24' },
                { id: 'warm', name: '溫馨手繪', bgImage: null, bg: '#fef3c7', border: '#d97706', font: 'sans-serif', textColor: '#78350f', accent: '#f59e0b' },
                // 更新版型：繽紛星空 (取代原極簡/未來科技)
                { id: 'starry', name: '繽紛星空', bgImage: null, bg: '#0f172a', border: '#38bdf8', font: 'sans-serif', textColor: '#f0f9ff', accent: '#fbbf24' },
                { id: 'cute', name: '粉嫩可愛', bgImage: null, bg: '#fff1f2', border: '#be123c', font: 'sans-serif', textColor: '#881337', accent: '#fda4af' },
                { id: 'nature', name: '自然清新', bgImage: null, bg: '#f0fdf4', border: '#15803d', font: 'serif', textColor: '#14532d', accent: '#86efac' },
                { id: 'elegant', name: '典雅質感', bgImage: null, bg: '#faf5ff', border: '#7e22ce', font: 'serif', textColor: '#581c87', accent: '#d8b4fe' }
            ];

            useEffect(() => {
                if (mode === 'single') {
                    setAiPrompt(`請扮演一位溫暖的國小班導師，針對學生「${studentName}」獲得「${awardTitle}」這個獎項，寫一段約 50 字的鼓勵評語。語氣要正向、具體，並能增強學生的自信心。請直接給我評語內容即可。`);
                } else {
                    setAiPrompt(`請扮演一位資深教師。我會提供一份學生名單與特質。請為每一位學生撰寫約 50 字的期末評語。
重要規則：
1. 語氣溫暖、正向。
2. 請嚴格遵守「CSV 格式」輸出，不要有表頭，不要有編號。
3. 【重要】請將結果放入「程式碼區塊 (Code Block)」中，以便我複製。
4. 每一行格式為：學生姓名,獎項名稱,評語內容

學生名單如下：
(請在此貼上您的學生名單，例如：王小明, 熱心助人)`);
                }
            }, [mode, studentName, awardTitle]);

            useEffect(() => {
                if (mode === 'batch' && batchData.length > 0) {
                    const current = batchData[currentBatchIndex];
                    setStudentName(current.name);
                    setAwardTitle(current.award);
                    setComment(current.comment);
                }
            }, [mode, batchData, currentBatchIndex]);

            const parseCSV = (text) => {
                let cleanText = text.replace(/```csv/g, '').replace(/```/g, '');
                const lines = cleanText.trim().split(/\r\n|\n|\r/);
                const data = [];
                lines.forEach(line => {
                    if (!line.trim()) return;
                    const parts = line.split(',');
                    if (parts.length >= 2) {
                        data.push({
                            name: parts[0].trim(),
                            award: parts[1].trim(),
                            comment: parts.slice(2).join(',').trim() || '表現優異，特此嘉獎！'
                        });
                    }
                });
                return data;
            };

            const handleCsvImport = () => {
                const data = parseCSV(csvInput);
                if (data.length > 0) {
                    setBatchData(data);
                    setCurrentBatchIndex(0);
                    alert(`成功匯入 ${data.length} 位學生資料！請使用右側預覽區下方的按鈕逐一下載。`);
                } else {
                    alert('無法識別資料，請確認格式。建議使用 AI 幫您產生標準格式。');
                }
            };

            const copyPrompt = () => {
                const textArea = document.createElement("textarea");
                textArea.value = aiPrompt;
                textArea.style.position = "fixed";
                textArea.style.left = "-9999px";
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    alert('指令已複製！');
                } catch (err) {
                    console.error('複製失敗', err);
                }
                document.body.removeChild(textArea);
            };

            const applyPreset = (preset) => {
                setAwardTitle(preset.title);
                setComment(preset.text);
                setShowPresets(false);
            };

            useEffect(() => {
                const canvas = canvasRef.current;
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                const template = templates.find(t => t.id === selectedTemplate) || templates[0];

                canvas.width = 1200;
                canvas.height = 800;

                const drawTextContent = () => {
                    ctx.textAlign = 'center';
                    ctx.font = `bold 80px ${template.font}`;
                    ctx.fillStyle = template.textColor;
                    ctx.fillText('榮 譽 狀', canvas.width / 2, 180);
                    ctx.font = `bold 60px ${template.font}`;
                    ctx.fillStyle = template.accent;
                    ctx.fillText(awardTitle, canvas.width / 2, 300);
                    ctx.font = `50px ${template.font}`;
                    ctx.fillStyle = template.textColor;
                    ctx.fillText(`茲獎勵 ${studentName} 同學`, canvas.width / 2, 400);
                    ctx.font = `40px ${template.font}`;
                    ctx.fillStyle = template.textColor;
                    const maxWidth = 800;
                    const words = comment.split('');
                    let line = '';
                    let y = 500;
                    const lineHeight = 60;
                    for(let n = 0; n < words.length; n++) {
                        const testLine = line + words[n];
                        const metrics = ctx.measureText(testLine);
                        if (metrics.width > maxWidth && n > 0) {
                            ctx.fillText(line, canvas.width / 2, y);
                            line = words[n];
                            y += lineHeight;
                        } else {
                            line = testLine;
                        }
                    }
                    ctx.fillText(line, canvas.width / 2, y);
                    ctx.font = `30px ${template.font}`;
                    ctx.textAlign = 'left';
                    ctx.fillText(`導師：${teacherName}`, 80, canvas.height - 60);
                    ctx.textAlign = 'right';
                    ctx.fillText(`日期：${date.replace(/-/g, '.')}`, canvas.width - 80, canvas.height - 60);
                    ctx.textAlign = 'center';
                    ctx.font = `italic 20px ${template.font}`;
                    ctx.globalAlpha = 0.5;
                    ctx.fillText('Powered by 親子天下翻轉教育', canvas.width / 2, canvas.height - 30);
                    ctx.globalAlpha = 1.0;
                };

                if (template.bgImage) {
                    const img = new Image();
                    img.crossOrigin = "anonymous";
                    img.src = template.bgImage;
                    img.onload = () => {
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        drawTextContent();
                    };
                    img.onerror = () => {
                        console.warn("使用預設樣式");
                        drawDefaultBackground();
                        drawTextContent();
                    };
                } else {
                    drawDefaultBackground();
                    drawTextContent();
                }

                function drawDefaultBackground() {
                    ctx.fillStyle = template.bg;
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.lineWidth = 20;
                    ctx.strokeStyle = template.border;
                    ctx.strokeRect(40, 40, canvas.width - 80, canvas.height - 80);
                    
                    if (template.id === 'classic') {
                        ctx.fillStyle = template.accent;
                        ctx.beginPath(); ctx.arc(100, 100, 30, 0, 2 * Math.PI); ctx.fill();
                        ctx.beginPath(); ctx.arc(canvas.width - 100, canvas.height - 100, 30, 0, 2 * Math.PI); ctx.fill();
                    } else if (template.id === 'warm') {
                        ctx.fillStyle = '#fcd34d'; 
                        for(let i=0; i<10; i++) { ctx.beginPath(); ctx.arc(Math.random() * canvas.width, Math.random() * canvas.height, 20, 0, 2 * Math.PI); ctx.fill(); }
                    } else if (template.id === 'starry') { // 繽紛星空
                        // 深邃背景
                        ctx.fillStyle = template.bg;
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        
                        // 霓虹邊框
                        ctx.lineWidth = 4;
                        ctx.strokeStyle = template.border;
                        ctx.strokeRect(30, 30, canvas.width - 60, canvas.height - 60);
                        
                        // 繽紛裝飾
                        const colors = ['#f472b6', '#38bdf8', '#fbbf24', '#a78bfa'];
                        // 角落裝飾圓
                        ctx.fillStyle = colors[0];
                        ctx.beginPath(); ctx.arc(0, 0, 150, 0, 2 * Math.PI); ctx.fill();
                        ctx.fillStyle = colors[1];
                        ctx.beginPath(); ctx.arc(canvas.width, 0, 100, 0, 2 * Math.PI); ctx.fill();
                        ctx.fillStyle = colors[2];
                        ctx.beginPath(); ctx.arc(canvas.width, canvas.height, 150, 0, 2 * Math.PI); ctx.fill();
                        ctx.fillStyle = colors[3];
                        ctx.beginPath(); ctx.arc(0, canvas.height, 100, 0, 2 * Math.PI); ctx.fill();
                        
                        // 隨機星點
                        ctx.fillStyle = '#ffffff';
                        for(let i=0; i<50; i++) {
                            ctx.beginPath();
                            ctx.arc(Math.random() * canvas.width, Math.random() * canvas.height, Math.random() * 2, 0, 2 * Math.PI);
                            ctx.fill();
                        }
                    } else if (template.id === 'cute') {
                         ctx.fillStyle = template.accent;
                         for(let i=0; i<6; i++) {
                             const x = 100 + i * 200;
                             ctx.beginPath(); ctx.arc(x, 80, 20, 0, 2*Math.PI); ctx.fill();
                             ctx.beginPath(); ctx.arc(x, canvas.height-80, 20, 0, 2*Math.PI); ctx.fill();
                         }
                    } else if (template.id === 'nature') {
                        ctx.fillStyle = template.accent;
                        ctx.fillRect(0, 0, 150, 150); ctx.fillRect(canvas.width-150, canvas.height-150, 150, 150);
                    } else if (template.id === 'elegant') {
                        ctx.strokeStyle = template.accent; ctx.lineWidth = 5; ctx.strokeRect(60, 60, canvas.width - 120, canvas.height - 120);
                    }
                }
            }, [studentName, awardTitle, comment, selectedTemplate, teacherName, date]);

            const downloadImage = () => {
                const canvas = canvasRef.current;
                const link = document.createElement('a');
                link.download = `${studentName}_${awardTitle}_獎狀.png`;
                try {
                    link.href = canvas.toDataURL();
                    link.click();
                } catch (e) {
                    alert("無法下載：背景圖可能不支援跨網域 (CORS)。");
                }
            };

            return (
                <div className="min-h-screen bg-gray-50 text-gray-800 font-sans">
                    <header className="bg-white shadow-sm border-b border-gray-200 p-4 sticky top-0 z-10">
                        <div className="max-w-6xl mx-auto flex items-center justify-between">
                            <div className="flex items-center gap-2">
                                <div className="bg-blue-600 text-white p-2 rounded font-bold text-xl">獎</div>
                                <h1 className="text-xl font-bold tracking-tight hidden md:block">班級獎狀產生器</h1>
                            </div>
                            <div className="flex bg-gray-100 p-1 rounded-lg">
                                <button onClick={() => setMode('single')} className={`flex items-center gap-2 px-4 py-2 rounded-md text-sm font-medium transition-all ${mode === 'single' ? 'bg-white shadow text-blue-600' : 'text-gray-500 hover:text-gray-700'}`}>
                                    <Icons.User /> 單張製作
                                </button>
                                <button onClick={() => setMode('batch')} className={`flex items-center gap-2 px-4 py-2 rounded-md text-sm font-medium transition-all ${mode === 'batch' ? 'bg-white shadow text-blue-600' : 'text-gray-500 hover:text-gray-700'}`}>
                                    <Icons.Users /> 批次匯入
                                </button>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-6xl mx-auto p-4 md:p-8 grid grid-cols-1 lg:grid-cols-12 gap-8">
                        <div className="lg:col-span-5 space-y-6">
                            <section className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 space-y-4">
                                <h2 className="text-lg font-bold flex items-center gap-2 text-gray-800"><Icons.Calendar /> 基本資料</h2>
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">導師姓名</label>
                                        <input type="text" value={teacherName} onChange={(e) => setTeacherName(e.target.value)} className="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 outline-none" />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">頒發日期</label>
                                        <input type="date" value={date} onChange={(e) => setDate(e.target.value)} className="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 outline-none" />
                                    </div>
                                </div>
                            </section>

                            {mode === 'single' ? (
                                <section className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 space-y-4 animate-fadeIn">
                                    <div className="flex justify-between items-center">
                                        <h2 className="text-lg font-bold flex items-center gap-2 mb-2"><Icons.Type /> 學生與獎項</h2>
                                        <div className="relative">
                                            <button onClick={() => setShowPresets(!showPresets)} className="text-xs bg-orange-100 text-orange-700 px-3 py-1 rounded-full font-bold hover:bg-orange-200 flex items-center gap-1 transition-colors">
                                                <Icons.BookOpen /> 快速套用範本
                                            </button>
                                            {showPresets && (
                                                <div className="absolute right-0 top-full mt-2 w-72 bg-white rounded-xl shadow-xl border border-gray-200 z-50 overflow-hidden max-h-96 overflow-y-auto">
                                                    <div className="p-3 bg-gray-50 border-b border-gray-100 text-xs font-bold text-gray-500">選擇內建獎項</div>
                                                    {presetAwards.map((p, i) => (
                                                        <button key={i} onClick={() => applyPreset(p)} className="w-full text-left p-3 hover:bg-blue-50 border-b border-gray-100 last:border-0 group">
                                                            <div className="flex items-center justify-between mb-1"><span className="font-bold text-gray-800">{p.title}</span><span className="text-[10px] bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded">{p.category}</span></div>
                                                            <p className="text-xs text-gray-500 line-clamp-2 group-hover:text-blue-700">{p.text}</p>
                                                        </button>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                    <div><label className="block text-sm font-medium text-gray-700 mb-1">學生姓名</label><input type="text" value={studentName} onChange={(e) => setStudentName(e.target.value)} className="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 outline-none" /></div>
                                    <div><label className="block text-sm font-medium text-gray-700 mb-1">獎項名稱</label><input type="text" value={awardTitle} onChange={(e) => setAwardTitle(e.target.value)} className="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 outline-none" /></div>
                                    <div>
                                        <div className="flex justify-between items-center mb-1"><label className="block text-sm font-medium text-gray-700">評語內容</label><span className="text-xs text-gray-400">{comment.length}/100字</span></div>
                                        <textarea rows="3" value={comment} onChange={(e) => setComment(e.target.value)} className="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 outline-none" />
                                    </div>
                                </section>
                            ) : (
                                <section className="bg-white p-6 rounded-xl shadow-sm border border-blue-200 ring-4 ring-blue-50 space-y-4 animate-fadeIn">
                                    <div className="flex items-center justify-between">
                                        <h2 className="text-lg font-bold flex items-center gap-2 mb-2"><Icons.FileText /> 批次資料匯入</h2>
                                        <span className="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-full">Pro 功能</span>
                                    </div>
                                    <div className="text-sm text-gray-600 mb-2">格式：<code className="bg-gray-100 px-1 rounded">姓名,獎項,評語</code></div>
                                    <textarea rows="5" placeholder={`王小明,熱心服務獎,這學期主動幫忙...\n李小華,數學進步獎,數學成績突飛猛進...`} value={csvInput} onChange={(e) => setCsvInput(e.target.value)} className="w-full border border-gray-300 rounded-md px-3 py-2 font-mono text-sm focus:ring-2 focus:ring-blue-500 outline-none" />
                                    <button onClick={handleCsvImport} className="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition-colors flex items-center justify-center gap-2">
                                        <Icons.Upload /> 匯入資料
                                    </button>
                                    {batchData.length > 0 && (
                                        <div className="mt-4 p-3 bg-green-50 rounded border border-green-200">
                                            <div className="flex justify-between items-center mb-2">
                                                <span className="text-sm font-bold text-green-800">已匯入 {batchData.length} 筆</span>
                                                <span className="text-xs text-green-600">預覽第 {currentBatchIndex + 1} 位</span>
                                            </div>
                                            <div className="flex gap-2">
                                                <button disabled={currentBatchIndex === 0} onClick={() => setCurrentBatchIndex(prev => prev - 1)} className="flex-1 bg-white border border-green-300 text-green-700 py-1 rounded disabled:opacity-50 flex justify-center"><Icons.ChevronLeft /></button>
                                                <button disabled={currentBatchIndex === batchData.length - 1} onClick={() => setCurrentBatchIndex(prev => prev + 1)} className="flex-1 bg-white border border-green-300 text-green-700 py-1 rounded disabled:opacity-50 flex justify-center"><Icons.ChevronRight /></button>
                                            </div>
                                        </div>
                                    )}
                                </section>
                            )}

                            <div className="bg-gradient-to-r from-purple-50 to-blue-50 p-4 rounded-lg border border-purple-100">
                                <div className="flex items-start gap-3">
                                    <div className="bg-purple-100 p-2 rounded-full shrink-0"><Icons.Sparkles className="text-purple-600" /></div>
                                    <div className="w-full">
                                        <h3 className="text-sm font-bold text-purple-900 mb-1">{mode === 'batch' ? 'AI 批次指令產生器' : 'AI 評語靈感助手'}</h3>
                                        <p className="text-xs text-purple-700 mb-2">您可以直接編輯下方的指令，修改成您喜歡的語氣，再複製給 AI。</p>
                                        <textarea value={aiPrompt} onChange={(e) => setAiPrompt(e.target.value)} className="w-full h-24 text-xs p-2 border border-purple-200 rounded bg-white/80 focus:ring-2 focus:ring-purple-400 outline-none mb-2 font-mono" />
                                        <div className="flex items-center justify-between">
                                            <span className="text-[10px] text-purple-500">{mode === 'batch' ? '提示：記得將您的學生名單也貼給 AI 喔！' : '提示：複製後前往 ChatGPT 貼上即可。'}</span>
                                            <button onClick={copyPrompt} className="flex items-center gap-1 text-xs bg-purple-600 hover:bg-purple-700 text-white px-3 py-1.5 rounded transition-colors shadow-sm whitespace-nowrap"><Icons.Copy /> 複製指令</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <section className="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                                <h2 className="text-lg font-bold flex items-center gap-2 mb-4"><Icons.Layout /> 選擇獎狀風格</h2>
                                <div className="grid grid-cols-3 gap-3">
                                    {templates.map((t) => (
                                        <button key={t.id} onClick={() => setSelectedTemplate(t.id)} className={`relative group aspect-square rounded-lg border-2 transition-all flex flex-col items-center justify-center p-2 text-center ${selectedTemplate === t.id ? 'border-blue-600 bg-blue-50' : 'border-gray-200 hover:border-blue-300 hover:bg-gray-50'}`}>
                                            <div className={`w-8 h-8 rounded-full mb-2 border`} style={{background: t.bg, borderColor: t.border}}></div>
                                            <span className="text-xs font-medium">{t.name}</span>
                                            {t.id === selectedTemplate && (<div className="absolute -top-2 -right-2 bg-blue-600 text-white rounded-full p-0.5"><Icons.CheckCircle /></div>)}
                                        </button>
                                    ))}
                                </div>
                            </section>
                        </div>

                        <div className="lg:col-span-7 space-y-6">
                            <div className="sticky top-24">
                                <div className="bg-gray-800 rounded-xl p-4 shadow-2xl">
                                    <div className="flex justify-between items-center text-gray-400 text-sm mb-2 px-2">
                                        <span className="flex items-center gap-2"><Icons.ImageIcon /> 即時預覽效果</span>
                                        <span>1200 x 800 px</span>
                                    </div>
                                    <div className="relative w-full aspect-[3/2] bg-gray-900 rounded-lg overflow-hidden border-2 border-gray-700">
                                        <canvas ref={canvasRef} className="w-full h-full object-contain" />
                                    </div>
                                    <p className="text-center text-gray-500 text-xs mt-4">
                                        * 圖片生成於您的裝置端，不會上傳至伺服器。
                                        {mode === 'batch' && <span className="text-yellow-500 block mt-1">批次模式提示：請使用「上一個/下一個」按鈕檢視每位學生，並逐一下載。</span>}
                                    </p>
                                </div>
                                
                                <button onClick={downloadImage} className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg hover:shadow-xl transition-all flex items-center justify-center gap-2 transform active:scale-95 mt-4">
                                    <Icons.Download /> {mode === 'batch' ? `下載目前的獎狀` : '下載圖片'}
                                </button>

                                <div className="mt-6 bg-gradient-to-br from-indigo-50 to-blue-50 rounded-xl border border-blue-100 p-6 shadow-sm">
                                    <div className="flex items-start gap-4">
                                        <div className="bg-white p-3 rounded-xl shadow-sm border border-gray-100 hidden md:block"><Icons.FileText className="text-indigo-600 w-8 h-8" /></div>
                                        <div className="flex-1">
                                            <h3 className="font-bold text-lg text-gray-900 flex items-center gap-2"><Icons.DownloadCloud /> 沒空一個個做？直接下載 30 款模板包！</h3>
                                            <p className="text-sm text-gray-600 mt-2 leading-relaxed">
                                                翻轉教育已為您準備好「30 種班級經營趣味獎狀」懶人包，包含 PDF 檔與可編輯的 Canva 模板。
                                            </p>
                                            <div className="flex flex-wrap gap-3 mt-4">
                                                <a href="https://flipedu.parenting.com.tw/teacher_resource/345?from=class_certificate" className="flex items-center gap-2 bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-indigo-700 transition-colors shadow-sm">立即前往下載 <Icons.ArrowRight /></a>
                                                <a href="https://flipedu.parenting.com.tw/teachingScope/45?from=class_certificate" className="flex items-center gap-2 bg-white text-indigo-700 border border-indigo-200 px-4 py-2 rounded-lg text-sm font-bold hover:bg-indigo-50 transition-colors">更多期末活動教學資源</a>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div className="bg-yellow-50 border border-yellow-200 rounded-xl p-5 mt-4">
                                    <div className="flex items-center gap-3">
                                        <div className="text-yellow-600">
                                            <Icons.Gift />
                                        </div>
                                        <div className="text-sm text-gray-800">
                                            <span className="font-bold">更多資源：</span> 翻轉教育教學資源專區還有 500+ 份教學用簡報、學習單等你挖掘！
                                            <a href="https://flipedu.parenting.com.tw/teacher_resource_list?from=class_certificate" className="text-blue-600 hover:underline ml-1 font-medium">前往教學資源專區</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<FlipAwardGenerator />);
    </script>
</body>
</html>
